<!DOCTYPE html>
<html>
<head>
  <title>Tokyo</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <meta charset="UTF-8">
</head>
<body>
  <div id="mapcontainer" style="position:absolute;top:0;left:0;right:0;bottom:0;"></div>

  <script>
    // ページ読み込み後にinit関数を呼び出す
    window.onload = init;

    function init() {
      var map = L.map('mapcontainer', { zoomControl: false });

      var initialLatLng = [35.68927557318069, 139.6997988239306];
      map.setView(initialLatLng, 13);

      L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>"
      }).addTo(map);

      // CSVファイルから緯度経度とポップアップ文字を読み取り、地図上にマーカーをプロット
      fetch('./place.csv', {
        headers: {
          'Content-Type': 'text/csv; charset=utf-8'
        }
      })
        .then(response => response.text())
        .then(data => {
          var lines = data.split('\n');
          var waypoints = [];

          for (var i = 1; i < lines.length; i++) { // 1行目はヘッダー
            var parts = lines[i].split(',');
            var lat = parseFloat(parts[0]);
            var lng = parseFloat(parts[1]);

            waypoints.push(L.latLng(lat, lng));

            // 画像を追加
            var imageNumber = i; // ファイル名に使う連番（1から始まると仮定）
            var imageUrl = `./img/${imageNumber}.jpg`;
            var imageHtml = `<img src="${imageUrl}" width="200" height="150">`;

            if (waypoints.length === 4) {
              // ルーティングの設定
              var routingControl = L.Routing.control({
                waypoints: [
                  L.latLng(waypoints[1].lat, waypoints[1].lng), // 2行目のポイント
                  L.latLng(waypoints[2].lat, waypoints[2].lng), // 3行目のポイント
                  L.latLng(waypoints[3].lat, waypoints[3].lng)  // 4行目のポイント
                ],
                routeWhileDragging: true
              }).addTo(map);
              
              routingControl.on('routesfound', function(event) {
                console.log('Routes found:', event.routes);
              });
              
              // マーカーにポップアップとツールチップを紐付け
              var popupContent = parts[2];
              if (parts.length > 3) popupContent += `<br>${parts[3]}`;
              if (parts.length > 4) popupContent += `<br>${parts[4]}`;
              if (parts.length > 5) popupContent += `<br>${parts[5]}`;
              var popup = L.popup({ maxWidth: 550 }).setContent(popupContent + "<br>" + imageHtml);
              var marker = L.marker([lat, lng])
                .bindPopup(popup)
                .bindTooltip(parts[2])
                .addTo(map);
            }
          }
        })
        .catch(error => console.error('Error:', error));
    }
  </script>
</body>
</html>
